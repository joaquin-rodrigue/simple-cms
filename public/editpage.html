<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple CMS</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

    <!-- Page styles -->
    <link href="style.css" rel="stylesheet" type="text/css">
    <script src="globalutils.js"></script>
</head>

<body>
    <div class="container not-logged-in" id="not-logged-in" hidden>
        <h1>You aren't logged in</h1>
        <h3><a href="login.html">Please log in here</a></h3>
    </div>

    <div class="container page-not-found" id="page-not-found" hidden>
        <h1>Page not found</h1>
        <h3><a href="createpage.html">Create this page</a></h3>
        <h3><a href="index.html">Back to Home</a></h3>
    </div>

    <div class="edit-page" id="edit-page" hidden>
        <!-- Thinking of putting this in an IFrame? -->
        <!-- I'm not quite sure how to do this but -->
        <header class="tools" id="tools">
            <ul>
                <li><button id="save-and-quit">Home</button></li>
                <li><button id="new-content">New</button></li>
                <li><button id="resize-content">Resize</button></li>
            </ul>
        </header>

        <div class="active" id="active">
            <div class="popup error error-popup" id="error-popup" hidden>&nbsp;</div>
            <div class="popup new-content-select" id="select-new-popup" hidden>
                <p>Select an item to add:</p>
                <button id="add-text">Text</button>
                <button id="add-header">Header</button>
                <button id="add-image">Image</button>
                <button id="add-section">Section</button>
                <button id="add-list">List</button>
                <button id="close" class="close-popup">Cancel</button>
            </div>
            <div class="popup place-new-element" id="place-new-element" hidden>
                <p>Type to enter text; Click to place</p>
            </div>
        </div>

        <!-- This is the part I'm thinking about putting in an IFrame -->
        <main class="page" id="page">

        </main>
    </div>

    <script>
        // Only display page editor if logged in
        if (document.cookie.includes('simplecmsloggedin')) {
            // get the page details from the database
            document.getElementById('not-logged-in').hidden = true;
            document.getElementById('not-logged-in').innerHTML = "";
            let fetchSettings = {
                method: 'GET'
            };
            const pageId = new URLSearchParams(window.location.search).get('id');
            //console.log(pageId);
            let title, head, body;

            if (typeof pageId !== 'string' || pageId.length === 0) {
                document.getElementById('page-not-found').hidden = false;
                console.log(`couldn't find the id, it looks like this: ${pageId} and is ${typeof(pageId)}`);
                document.getElementById('edit-page').innerHTML = "";
            }
            else {
                // I'm thinking the page id will be passed via the URL
                //console.log(`${serverAddress}/webpage/${pageId}`);
                fetch(`${serverAddress}/webpage/${pageId}`, fetchSettings)
                    .then(response => {
                        return new Promise(resolve => response.json()
                            .then(json => resolve({
                                status: response.status,
                                json,
                            })
                        ));
                    })
                    .then(({ status, json }) => {
                        // i hate types in js
                        if ((status === 200 || status === 304) && json.data['0'].owner == locateID(document.cookie)) {
                            title = json.data['0'].name;
                            head = json.data['0'].head;
                            body = json.data['0'].body;
                            document.getElementById('edit-page').hidden = false;
                            document.getElementById('page-not-found').innerHTML = "";
                            // Hooray we have page data
                            document.getElementById('page').innerHTML = body;
                            document.getElementById('save-and-quit').addEventListener('click', saveAndQuit);
                            document.getElementById('new-content').addEventListener('click', newContent);
                            document.getElementById('add-text').addEventListener('click', placeTextOnPage);
                            document.getElementById('add-header').addEventListener('click', placeHeaderOnPage);
                            document.getElementById('add-image').addEventListener('click', placeImageOnPage);
                            document.getElementById('add-section').addEventListener('click', placeSectionOnPage);
                            document.getElementById('add-list').addEventListener('click', placeListOnPage);
                        }
                        else {
                            document.getElementById('page-not-found').hidden = false;
                            console.log(`couldnt find the thingy, data owner: ${json.data['0'].owner}, cookie: ${locateID(document.cookie)}`)
                            document.getElementById('edit-page').innerHTML = "";
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // I kinda don't know what to do here so I'm redirecting
                        //window.location.replace('index.html');
                    });
            }
            
        }
        else {
            document.getElementById('not-logged-in').hidden = false;
            document.getElementById('page-not-found').innerHTML = "";
            document.getElementById('edit-page').innerHTML = "";
        } 

        // --- HELPFUL FUNCTIONS ---
        // Closes all popups
        const closePopups = () => {
            document.getElementById('error-popup').hidden = true;
            document.getElementById('select-new-popup').hidden = true;
            document.getElementById('place-new-element').hidden = true;
            // ... add other popups to close here
        }

        // --- EDIT PAGE FUNCTIONS ---
        // Save and quit button
        const saveAndQuit = () => {
            fetchSettings = {
                method: 'PUT'
            };

            fetch(`${serverAddress}/webpage/${pageId}`, fetchSettings)
                .then(response => {
                    return new Promise(resolve => response.json()
                        .then(json => resolve({
                            status: response.status,
                            json
                        })
                    ));
                })
                .then(({ status, json }) => {
                    if (status === 200) {
                        // data saved successfully, we can redirect
                        window.location.replace('mypages.html');
                    }
                    else {
                        document.getElementById('error-popup').hidden = false;
                        document.getElementById('error-popup').innerHTML = `
                            <p>Couldn't save the page!</p>
                            <button class='close-popup' onclick='closePopups'>Ok</button>`;
                    }
                });
        }

        // Add new content popup - this isn't the function that does the work
        const newContent = () => {
            document.getElementById('select-new-popup').hidden = false;
        }

        // Lets the user place an element on the page - this also doesn't do the work, or at least it only does some of it
        const placeTextOnPage = () => {
            document.getElementById('select-new-popup').hidden = true;
            document.getElementById('place-new-element').hidden = false;
            document.getElementById('place-new-element').innerHTML = `
                <input type='text' placeholder='Type to enter text, click to add to page'>`;
            document.getElementById('page').addEventListener('click', addElementToPage(event));
        }
        const placeHeaderOnPage = () => {
            document.getElementById('select-new-popup').hidden = true;
            document.getElementById('place-new-element').hidden = false;
            document.getElementById('place-new-element').innerHTML = `
                <p>Header type:</p>
                <ul>
                    <li>H1</l1>
                    <li>H2</li>
                    <li>H3</li>
                    <li>H4</li>
                    <li>H5</li>
                    <li>H6</li>
                </ul>
                <input type="text" placeholder='Type to enter text, click to add to page'>`;
            document.getElementById('page').addEventListener('click', addElementToPage(event))
        }
        // ---- TOODODODODODODODOODODKOGSOIOEINJOVNWEJFOIWEIOFJIWOEJFOEWJFOIEWJFOIJEWOIFJEWIOKFJIEWJFOIEWFEWJIFEW ----
        const placeImageOnPage = () => {
            document.getElementById('select-new-popup').hidden = true;
            document.getElementById('place-new-element').hidden = false;
            document.getElementById('place-new-element').innerHTML = `
                <p>TODO: image placer, sorry!</p>`;
        }
        const placeSectionOnPage = () => {
            document.getElementById('select-new-popup').hidden = true;
            document.getElementById('place-new-element').hidden = false;
            document.getElementById('place-new-element').innerHTML = `
                <p>Click to place on page</p>`;
        }
        const placeListOnPage = () => {

        }

        // This is the function that does the work
        const addElementToPage = (event) => {
            // element is literally the name of the html tag; i.e.
            // if element = p, then this will generate a <p> element
            // realizing I'm not quite sure how to move the element to a specific part of
            // the page, so for now, I'm going to make it so the user can add elements on
            // to the end of a page/container
            document.getElementById('page').removeEventListener('click');
            let element = document.getElementById('place-new-element'); // literally just this element
            let x = event.x, y = event.y;
        }
    </script>
</body>

</html>